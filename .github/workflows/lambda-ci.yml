name: Lambda CI

on:
  push:
    branches: ['main']
    paths:
      - 'lambda/**'
  pull_request:
    branches: ['main']
    paths:
      - 'lambda/**'

jobs:
  lint:
    name: CI
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        lambda_function:
          - osrs-tracker_item-info
          - osrs-tracker_item-search
          - osrs-tracker_player-hiscores
          - osrs-tracker_player-info
          - osrs-tracker_process-items
          - osrs-tracker_process-players
          - osrs-tracker_queue-items
          - osrs-tracker_queue-players

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Path filter
        uses: dorny/paths-filter@v2.2.1
        id: filter
        with:
          filters: |
            lambda_function: 
              - lambda/${{ matrix.lambda_function }}/**

      - if: ${{ steps.filter.outputs.lambda_function == 'true' }}
        name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'

      - if: ${{ steps.filter.outputs.lambda_function == 'true' }}
        name: Install
        run: npm ci
        working-directory: lambda/${{ matrix.lambda_function }}

      - if: ${{ steps.filter.outputs.lambda_function == 'true' }}
        name: ESlint
        run: npm run lint
        working-directory: lambda/${{ matrix.lambda_function }}

      - if: ${{ steps.filter.outputs.lambda_function == 'true' }}
        name: Prettier
        run: npm run prettier:ci
        working-directory: lambda/${{ matrix.lambda_function }}

      - if: ${{ steps.filter.outputs.lambda_function == 'true' }}
        name: Build
        run: npm run build:prod
        working-directory: lambda/${{ matrix.lambda_function }}
